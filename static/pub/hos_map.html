<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<style type="text/css">
		body, html 
		{
			width: 100%;
			height: 100%; 
			margin:0;
			font-family:"微软雅黑";
		}
		#allmap
		{
			height:500px;
			width:100%;
		}
		#driving_way{
			margin: 0px auto;
		}
		#driving_way select{
			width: 55%;
			font-size: 20px;
			height: 30px;
			line-height: 30px;
			text-align: center;
			border-radius: 5px;
			/*margin-left: 13px;*/
		}
		#result{
			font-size: 20px;
			line-height: 30px;
			text-align: center;
			width: 43%;
			border-radius: 5px;
			background-color: white;
		}
	</style>
	<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=WUYWS5AH6Yb44zHQHr7HQXMTG4aUGGxD"></script>
	<script src="http://libs.baidu.com/jquery/1.9.0/jquery.js"></script>
	<title></title>
</head>
<body>
	<div id="driving_way">
		<select>
			<option value="0">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最少时间</option>
			<option value="1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最短距离</option>
			<option value="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;避开高速</option>
		</select>
		<button id="result">查询</button>
	</div>
	<div id="allmap"></div>
</body>
</html>
<script type="text/javascript">
	
	// 百度地图API功能
	var map = new BMap.Map("allmap");
	var start = {lng:null,lat:null};
	var end={lon:null,lat:null};   //终点坐标
	var watchID;    //用来存放持续追踪的监视Id
	var endAddress; //终点地址
	
	//检测设备是否支持定位功能
	if(window.navigator.geolocation){
    	var geolocation=window.navigator.geolocation;

    	//每一次位置的变化，就获取一次设备的位置，都会执行getPositionSuccess回调函数
    	watchID= geolocation.watchPosition(getPositionSuccess,getPositionError);
	}else{
    	 $("#allmap").innerHTML="该浏览器不支持获取地理位置。";
	}
	
	map.addControl(new BMap.NavigationControl());
	
	//接收页面传来的参数
	var request =
	{
    	QueryString : function(val){
    	var uri = window.location.search;
    	var re = new RegExp(val+ "=([^&?]*)", "ig");
    	return ( (uri.match(re)) ?(uri.match(re)[0].substr(val.length+1)):null);
    	}
	}
	endAddress= decodeURI(request.QueryString("address"));
	
	//终点地址转化为地图坐标
	// 创建地址解析器实例
	var myGeo = new BMap.Geocoder();
	// 将地址解析结果显示在地图上,并调整地图视野
	myGeo.getPoint(endAddress, function(point){
		if (point) {
			end.lon = point.lng;
			end.lat = point.lat;
			//alert(end.lon+','+end.lat);
			//在地图上定位到该点
			map.centerAndZoom(point, 16);
			map.addOverlay(new BMap.Marker(point));
		}else{
			alert("您选择地址没有解析到结果!");
		}
	});
	
	//三种驾车策略：最少时间，最短距离，避开高速
	var routePolicy = [BMAP_DRIVING_POLICY_LEAST_TIME,BMAP_DRIVING_POLICY_LEAST_DISTANCE,BMAP_DRIVING_POLICY_AVOID_HIGHWAYS];
	$("#result").click(function(){
		map.clearOverlays(); 
		var i=$("#driving_way select").val();
		search(start,end,routePolicy[i]); 
	});
	
	//查询路线
	function search(start,end,route){
		var myP1 = new BMap.Point(start.lng,start.lat);    //起点
    	var myP2 = new BMap.Point(end.lon,end.lat);    //终点
		var driving = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true},policy: route});
		driving.search(myP1,myP2 );
	}

	//终止watchPosition持续追踪的方法
	function stopWatch(){
    	if(watchID){
        	//调用clearWatch方法终止持续追踪
        	window.navigator.geolocation.clearWatch(watchID);
        	watchID=null;
    	}
	}

	//获取用户位置信息成功调用的方法
	function getPositionSuccess(position){
    	start.lng=position.coords.longitude;  //读取经度
    	start.lat=position.coords.latitude;   //读取纬度
	}

	//获取用户位置信息失败调用的方法
	function getPositionError(error){
    	
    	switch(error.code)
    	{ 
        	case error.PERMISSION_DENIED: 
            	$("#allmap").innerHTML="用户拒绝对获取地理位置的请求。" 
            	break; 
        	case error.POSITION_UNAVAILABLE: 
            	$("#allmap").innerHTML="位置信息是不可用的。" 
            	break; 
        	case error.TIMEOUT: 
            	$("#allmap").innerHTML="请求用户地理位置超时。" 
            	break; 
        	case error.UNKNOWN_ERROR: 
            	$("#allmap").innerHTML="未知错误。" 
            	break; 
    	} 
	}

</script>
